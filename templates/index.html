<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Medical Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Shared styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #chat-box::-webkit-scrollbar,
        #log-table-body::-webkit-scrollbar {
            width: 8px;
        }

        #chat-box::-webkit-scrollbar-thumb,
        #log-table-body::-webkit-scrollbar-thumb {
            background: #00796b;
            border-radius: 4px;
        }

        #chat-box::-webkit-scrollbar-track,
        #log-table-body::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #00796b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
        }

        .hidden {
            display: none;
        }

        /* Slider Styles */
        .img-comp-container {
            position: relative;
            height: 400px;
            width: 100%;
            overflow: hidden;
            border-radius: 8px;
            background-color: #f0f0f0;
        }

        .img-comp-img {
            position: absolute;
            width: auto;
            height: 100%;
            overflow: hidden;
        }

        .img-comp-img img {
            display: block;
            height: 100%;
            width: auto;
            max-width: none;
        }

        .img-comp-slider {
            position: absolute;
            z-index: 9;
            cursor: ew-resize;
            width: 40px;
            height: 40px;
            background-color: #00796b;
            opacity: 0.7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .img-comp-slider::before {
            content: '< >';
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-teal-50 to-cyan-100 min-h-screen font-sans">

    <header class="py-4 text-center shadow-md bg-teal-800 text-white flex justify-between items-center px-6">
        <div>
            <h1 class="text-3xl font-bold">AI-Powered Medical Assistant</h1>
            <p id="welcome-message" class="text-md text-teal-100"></p>
        </div>
        <button id="logout-btn"
            class="hidden bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200">
            Logout
        </button>
    </header>

    <main class="w-full p-4 md:p-8">

        <div id="auth-view">
            <div class="max-w-md mx-auto glass-card rounded-xl shadow-2xl p-6">
                <h2 id="auth-title" class="text-2xl font-semibold text-teal-900 text-center mb-4">Login</h2>
                <p id="auth-error" class="text-red-600 text-center mb-4"></p>
                <div class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="auth-email"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="auth-password"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <button id="auth-submit-btn"
                        class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-teal-700 transition duration-200">Login</button>
                    <button id="auth-toggle-btn" class="w-full text-sm text-center text-teal-700 hover:underline">Need
                        an account? Sign Up</button>
                </div>
            </div>
        </div>

        <div id="app-view" class="hidden">

            <div id="patient-dashboard" class="hidden container mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                <section class="glass-card rounded-xl shadow-2xl p-6">
                    <h2 class="text-2xl font-semibold text-teal-900 border-b-2 border-teal-300 pb-2 mb-4">
                        Neurological Symptom Assessor
                    </h2>
                    <div id="chat-window"
                        class="flex flex-col h-[500px] bg-white rounded-lg shadow-inner overflow-hidden">
                        <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-4">
                            <div class="bot-message"><span
                                    class="p-3 rounded-lg bg-teal-100 inline-block"><strong>Disclaimer:</strong> I am
                                    not a doctor. This is not a medical diagnosis. Please describe a symptom, or type
                                    'stop' to finish.</span></div>
                        </div>
                        <div class="p-4 bg-gray-100 border-t flex">
                            <input type="text" id="user-input" placeholder="Type your symptoms here..."
                                class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <button id="send-btn"
                                class="bg-teal-600 text-white px-6 py-3 rounded-r-lg font-semibold hover:bg-teal-700 transition duration-200">Send</button>
                        </div>
                    </div>
                </section>
                <section class="glass-card rounded-xl shadow-2xl p-6">
                    <h2 class="text-2xl font-semibold text-teal-900 border-b-2 border-teal-300 pb-2 mb-4">
                        Upload Your MRI Image
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-gray-700">Your Full
                                Name</label>
                            <input type="text" id="patient-name"
                                class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                placeholder="Enter your name so the doctor can identify you">
                            <button id="name-save-btn"
                                class="mt-2 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">
                                Save Name
                            </button>
                        </div>
                        <hr>
                        <form id="upload-form" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Doctor's Code</label>
                                <input type="text" id="doctor-code"
                                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500"
                                    placeholder="Enter the code provided by your doctor" required>
                            </div>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer"
                                onclick="document.getElementById('image-upload').click()">
                                <input type="file" id="image-upload" class="hidden" accept="image/*,.dcm" required>
                                <p class="text-gray-500">Click to upload MRI Scan (PNG/JPG/DICOM)</p>
                                <p id="file-name" class="text-sm text-teal-600 mt-2 font-medium"></p>
                            </div>
                            <button type="submit" id="upload-btn"
                                class="w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition-colors font-semibold shadow-md">
                                Upload & Enhance Image
                            </button>
                        </form>

                        <!-- Progress UI (Hidden by default) -->
                        <div id="progress-container" class="hidden mt-6 space-y-3">
                            <div class="flex justify-between text-sm font-medium text-gray-700">
                                <span id="progress-status">Starting...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                <div id="progress-bar"
                                    class="bg-teal-600 h-2.5 rounded-full transition-all duration-300"
                                    style="width: 0%"></div>
                            </div>
                        </div>

                        <div id="upload-message" class="mt-4 text-center font-medium"></div>

                        <hr class="border-gray-200 my-6">

                        <!-- HIPAA Danger Zone -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h3 class="text-red-800 font-semibold mb-2">HIPAA Patient Rights</h3>
                            <p class="text-red-600 text-sm mb-3">You have the right to request the deletion of all your
                                medical data stored on this server.</p>
                            <button onclick="deleteMyData()"
                                class="w-full bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200 text-sm">
                                Delete My Data (Permanent)
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <div id="doctor-dashboard" class="hidden">
                <section class="glass-card rounded-xl shadow-2xl p-6 w-full">
                    <h2 class="text-2xl font-semibold text-teal-900 border-b-2 border-teal-300 pb-2 mb-4">
                        Doctor's Dashboard: Patient Image Log
                    </h2>
                    <button id="refresh-log-btn"
                        class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition duration-200 mb-4">
                        Refresh Log
                    </button>
                    <div id="log-loader" class="loader hidden mx-auto my-12"></div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow-inner">
                        <table class="w-full table-fixed">
                            <thead class="bg-teal-700 text-white">
                                <tr>
                                    <th class="p-3 text-left w-1/4">Patient Name</th>
                                    <th class="p-3 text-left w-1/6">Upload Date</th>
                                    <th class="p-3 text-left w-1/4">Original Filename</th>
                                    <th class="p-3 text-left w-1/3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

        </div>

        <!-- Compare Modal -->
        <div id="compare-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl relative">
                <button id="close-compare-modal"
                    class="absolute top-4 right-4 text-gray-600 hover:text-red-600 text-2xl font-bold">&times;</button>
                <h2 class="text-2xl font-semibold text-teal-900 mb-4">Before / After Comparison</h2>

                <!-- View Toggle -->
                <div class="flex justify-center space-x-4 mb-6">
                    <button id="btn-view-slider"
                        class="px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold shadow-md transition-colors">Slider
                        View</button>
                    <button id="btn-view-side"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Side-by-Side</button>
                </div>

                <!-- Slider View -->
                <div id="view-slider">
                    <div class="flex justify-center mb-2 space-x-8 text-sm font-bold text-gray-500">
                        <span>Original</span>
                        <span>Enhanced</span>
                    </div>
                    <div id="compare-container-wrapper" class="flex justify-center">
                        <div class="img-comp-container shadow-lg" id="img-comp-container"
                            style="max-width: 600px; margin: 0 auto;">
                            <div class="img-comp-img">
                                <img id="compare-img-after" src="" alt="Enhanced">
                            </div>
                            <div class="img-comp-img img-comp-overlay">
                                <img id="compare-img-before" src="" alt="Original">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-center text-gray-500 text-sm">
                        Drag the slider to compare images.
                    </div>
                </div>

                <!-- Side-by-Side View -->
                <div id="view-side" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="font-bold text-gray-600 mb-2">Original</p>
                            <img id="side-img-orig" src="" class="w-full rounded-lg shadow-md border border-gray-200"
                                alt="Original">
                        </div>
                        <div class="text-center">
                            <p class="font-bold text-teal-600 mb-2">Enhanced</p>
                            <img id="side-img-enh" src="" class="w-full rounded-lg shadow-md border border-teal-200"
                                alt="Enhanced">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTokhR7dFJ9ApPZgv3U--6a4CJAQ7NJRs",
            authDomain: "mri-enhancement.firebaseapp.com",
            projectId: "mri-enhancement",
            storageBucket: "mri-enhancement.firebasestorage.app",
            messagingSenderId: "119965839774",
            appId: "1:119965839774:web:ee8faafb8408b8e71c668f",
            measurementId: "G-2K4D7LDK6Y"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. GLOBAL VARIABLES ---
        let currentUser = null;
        let idToken = null;
        let userRole = 'patient';
        let userName = 'Patient';

        // --- 3. DOM ELEMENT REFERENCES ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMessage = document.getElementById('welcome-message');

        const patientDashboard = document.getElementById('patient-dashboard');
        const doctorDashboard = document.getElementById('doctor-dashboard');

        // --- 4. AUTHENTICATION UI LOGIC ---
        const authTitle = document.getElementById('auth-title');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authError = document.getElementById('auth-error');
        let isLogin = true;

        authToggleBtn.onclick = () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? 'Login' : 'Sign Up';
            authSubmitBtn.textContent = isLogin ? 'Login' : 'Sign Up';
            authToggleBtn.textContent = isLogin ? 'Need an account? Sign Up' : 'Have an account? Login';
            authError.textContent = '';
        };

        authSubmitBtn.onclick = async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            authError.textContent = '';
            try {
                if (isLogin) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
            } catch (error) {
                authError.textContent = error.message;
            }
        };

        logoutBtn.onclick = () => auth.signOut();

        // --- 5. AUTH STATE LISTENER ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                try {
                    idToken = await user.getIdToken();

                    // --- NEW: Fetch Role from Backend (Bypasses Firestore Client Rules) ---
                    try {
                        const profileResponse = await fetchWithAuth('/api/get_profile');
                        if (profileResponse.ok) {
                            const profileData = await profileResponse.json();
                            userRole = profileData.role || 'patient';
                            userName = profileData.name || 'Patient';
                        } else {
                            throw new Error("Failed to fetch profile from server");
                        }
                    } catch (apiError) {
                        console.error("Error fetching profile from API, falling back to basic:", apiError);
                        // Fallback: Try to guess or just default to patient
                        userRole = 'patient';
                        userName = 'Patient (Offline)';
                    }
                    // ----------------------------------------------------------------------

                    welcomeMessage.textContent = `Welcome, ${userName} (Role: ${userRole})`;

                    authView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');

                    patientDashboard.classList.add('hidden');
                    doctorDashboard.classList.add('hidden');

                    if (userRole === 'doctor') {
                        doctorDashboard.classList.remove('hidden');
                        initDoctorLog();
                    } else {
                        patientDashboard.classList.remove('hidden');
                        initChatbot();
                        initPatientUpload();
                    }
                } catch (e) {
                    console.error("Login initialization error:", e);
                    alert("Login failed during initialization: " + e.message);
                    // Force sign out to reset state
                    auth.signOut();
                }

            } else {
                currentUser = null;
                idToken = null;
                userRole = 'patient';
                welcomeMessage.textContent = '';
                authView.classList.remove('hidden');
                appView.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        });

        // --- 6. API CALL HELPER ---
        async function fetchWithAuth(url, options = {}) {
            if (!idToken) throw new Error("User not authenticated");
            const headers = {
                ...(options.headers || {}),
                'Authorization': `Bearer ${idToken}`,
            };
            if (options.body && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            return fetch(url, { ...options, headers });
        }

        // --- 7. CHATBOT FUNCTIONALITY ---
        function initChatbot() {
            const chatBox = document.getElementById("chat-box");
            const userInput = document.getElementById("user-input");
            const sendBtn = document.getElementById("send-btn");

            function addMessage(message, sender) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-3`;
                const span = document.createElement("span");
                span.className = `p-3 rounded-lg ${sender === 'user' ? 'bg-teal-600 text-white' : 'bg-teal-100 text-gray-800'} inline-block max-w-xs`;
                if (sender === 'bot') {
                    const pre = document.createElement("pre");
                    pre.textContent = message;
                    pre.className = "whitespace-pre-wrap font-sans";
                    span.appendChild(pre);
                } else {
                    span.textContent = message;
                }
                messageDiv.appendChild(span);
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            async function handleChat() {
                const message = userInput.value.trim();
                if (!message) return;
                addMessage(message, 'user');
                userInput.value = "";
                try {
                    const response = await fetchWithAuth('/api/chat', {
                        method: 'POST',
                        body: JSON.stringify({ message: message }),
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    addMessage(data.reply, 'bot');
                } catch (error) {
                    console.error("Error in chat:", error);
                    addMessage(`Error: ${error.message}`, 'bot');
                }
            }

            if (sendBtn && userInput) {
                sendBtn.onclick = handleChat;
                userInput.onkeypress = (e) => { if (e.key === "Enter") handleChat(); };
            }
        }

        // --- 8. PATIENT UPLOAD FUNCTIONALITY ---
        function initPatientUpload() {
            const patientNameInput = document.getElementById("patient-name");
            const nameSaveBtn = document.getElementById("name-save-btn");
            const uploadMessage = document.getElementById("upload-message");

            patientNameInput.value = userName;

            nameSaveBtn.onclick = async () => {
                const newName = patientNameInput.value.trim();
                if (!newName) { alert("Please enter a name."); return; }
                try {
                    const response = await fetchWithAuth('http://127.0.0.1:5000/api/set_profile', {
                        method: 'POST',
                        body: JSON.stringify({ name: newName })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    userName = data.name;
                    welcomeMessage.textContent = `Welcome, ${userName} (Role: ${userRole})`;
                    uploadMessage.textContent = "Name updated!";
                    uploadMessage.className = "mt-4 text-center font-medium text-green-600";
                } catch (e) {
                    uploadMessage.textContent = `Error: ${e.message}`;
                    uploadMessage.className = "mt-4 text-center font-medium text-red-600";
                }
            };

            const uploadForm = document.getElementById("upload-form");
            const fileInput = document.getElementById("image-upload");
            const fileNameDisplay = document.getElementById("file-name");
            const doctorCodeInput = document.getElementById("doctor-code");
            const uploadBtn = document.getElementById("upload-btn");
            const progressContainer = document.getElementById("progress-container");
            const progressBar = document.getElementById("progress-bar");
            const progressStatus = document.getElementById("progress-status");
            const progressPercent = document.getElementById("progress-percent");

            fileInput.onchange = () => {
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = "Selected: " + fileInput.files[0].name;
                } else {
                    fileNameDisplay.textContent = "";
                }
            };

            uploadForm.onsubmit = async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                const doctorCode = doctorCodeInput.value.trim();

                if (!file) {
                    uploadMessage.textContent = "Please select a file.";
                    uploadMessage.className = "mt-4 text-center font-medium text-red-600";
                    return;
                }
                if (!doctorCode) {
                    uploadMessage.textContent = "Please enter the Doctor's Code.";
                    uploadMessage.className = "mt-4 text-center font-medium text-red-600";
                    return;
                }

                // Reset UI
                uploadMessage.textContent = "";
                uploadBtn.classList.add("hidden");
                progressContainer.classList.remove("hidden");
                progressBar.style.width = "0%";
                progressPercent.textContent = "0%";
                progressStatus.textContent = "Starting upload...";
                progressBar.classList.remove("bg-red-600");

                // Simulate Progress
                let progress = 0;
                // Slower interval (800ms) to better match CPU inference time
                const interval = setInterval(() => {
                    if (progress < 95) { // Allow it to creep up to 95%
                        let increment = 0;
                        if (progress < 30) {
                            // Uploading phase: fast
                            increment = Math.random() * 5;
                        } else if (progress < 80) {
                            // Enhancing phase (early): moderate
                            increment = Math.random() * 1;
                        } else {
                            // Enhancing phase (late): very slow, so it doesn't just halt at 90%
                            increment = Math.random() * 0.2;
                        }

                        progress += increment;
                        if (progress > 95) progress = 95; // Cap at 95% until done

                        progressBar.style.width = `${Math.round(progress)}%`;
                        progressPercent.textContent = `${Math.round(progress)}%`;

                        if (progress < 30) {
                            progressStatus.textContent = "Uploading Image...";
                        } else if (progress < 95) {
                            progressStatus.textContent = "Enhancing with Real-ESRGAN... (running AI model)";
                        } else {
                            progressStatus.textContent = "Finalizing...";
                        }
                    }
                }, 800);

                const formData = new FormData();
                formData.append('image', file);
                formData.append('doctorCode', doctorCode);
                // Fix: Use the current value from input, not the possibly stale global variable
                // This ensures "Alpha test 1" is sent even if user didn't click "Save Name"
                formData.append('patientName', patientNameInput.value.trim() || userName);

                try {
                    const response = await fetchWithAuth('/api/upload_image', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    clearInterval(interval);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    progressBar.style.width = "100%";
                    progressPercent.textContent = "100%";
                    progressStatus.textContent = "Done!";

                    setTimeout(() => {
                        uploadMessage.textContent = "✅ " + data.message;
                        uploadMessage.className = "mt-4 text-center font-medium text-green-600";

                        setTimeout(() => {
                            uploadForm.reset();
                            fileNameDisplay.textContent = "";
                            progressContainer.classList.add("hidden");
                            uploadBtn.classList.remove("hidden");
                        }, 3000);
                    }, 500);

                } catch (error) {
                    clearInterval(interval);
                    progressBar.classList.add("bg-red-600");
                    progressStatus.textContent = "Error";
                    uploadMessage.textContent = "❌ Error: " + error.message;
                    uploadMessage.className = "mt-4 text-center font-medium text-red-600";

                    setTimeout(() => {
                        uploadBtn.classList.remove("hidden");
                        progressBar.classList.remove("bg-red-600");
                    }, 2000);
                }
            };
        }

        // --- 9. Helper to fetch blob and create object URL ---
        async function fetchImageBlob(url) {
            const response = await fetchWithAuth(url, { method: 'GET' });
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Failed to load image (${response.status} ${response.statusText}): ${text}`);
            }
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        // --- 10. SLIDER / COMPARE MODAL LOGIC ---
        function initCompareSlider(originalUrl, enhancedUrl) {
            const modal = document.getElementById('compare-modal');
            const closeBtn = document.getElementById('close-compare-modal');
            const container = document.getElementById('img-comp-container');
            const imgBefore = document.getElementById('compare-img-before');
            const imgAfter = document.getElementById('compare-img-after');

            const viewSliderBtn = document.getElementById('btn-view-slider');
            const viewSideBtn = document.getElementById('btn-view-side');
            const viewSlider = document.getElementById('view-slider');
            const viewSide = document.getElementById('view-side');
            const sideImgOrig = document.getElementById('side-img-orig');
            const sideImgEnh = document.getElementById('side-img-enh');

            // Side-by-side images
            sideImgOrig.src = originalUrl;
            sideImgEnh.src = enhancedUrl;

            // Toggle logic
            viewSliderBtn.onclick = () => {
                viewSlider.classList.remove('hidden');
                viewSide.classList.add('hidden');
                viewSliderBtn.className = "px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold shadow-md transition-colors";
                viewSideBtn.className = "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors";
            };

            viewSideBtn.onclick = () => {
                viewSlider.classList.add('hidden');
                viewSide.classList.remove('hidden');
                viewSideBtn.className = "px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold shadow-md transition-colors";
                viewSliderBtn.className = "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors";
            };

            // Default to slider view
            viewSliderBtn.click();

            // Reset slider container
            container.innerHTML = '';

            const divAfter = document.createElement('div');
            divAfter.className = 'img-comp-img';
            const iAfter = document.createElement('img');
            iAfter.src = enhancedUrl;
            divAfter.appendChild(iAfter);

            const divBefore = document.createElement('div');
            divBefore.className = 'img-comp-img img-comp-overlay';
            const iBefore = document.createElement('img');
            iBefore.src = originalUrl;
            divBefore.appendChild(iBefore);

            container.appendChild(divAfter);
            container.appendChild(divBefore);

            modal.classList.remove('hidden');

            closeBtn.onclick = () => {
                modal.classList.add('hidden');
            };

            const startComparison = () => {
                container.style.width = iAfter.offsetWidth + "px";
                compareImages(divBefore);
            };

            if (iAfter.complete) {
                startComparison();
            } else {
                iAfter.onload = startComparison;
            }

            function compareImages(img) {
                let slider, clicked = 0, w, h;

                w = img.offsetWidth;
                h = img.offsetHeight;

                img.style.width = (w / 2) + "px";

                slider = document.createElement("DIV");
                slider.setAttribute("class", "img-comp-slider");
                img.parentElement.insertBefore(slider, img);

                slider.style.top = (h / 2) - (slider.offsetHeight / 2) + "px";
                slider.style.left = (w / 2) - (slider.offsetWidth / 2) + "px";

                slider.addEventListener("mousedown", slideReady);
                window.addEventListener("mouseup", slideFinish);
                slider.addEventListener("touchstart", slideReady);
                window.addEventListener("touchend", slideFinish);

                function slideReady(e) {
                    e.preventDefault();
                    clicked = 1;
                    window.addEventListener("mousemove", slideMove);
                    window.addEventListener("touchmove", slideMove);
                }

                function slideFinish() {
                    clicked = 0;
                    window.removeEventListener("mousemove", slideMove);
                    window.removeEventListener("touchmove", slideMove);
                }

                function slideMove(e) {
                    let pos;
                    if (clicked === 0) return;
                    pos = getCursorPos(e);
                    if (pos < 0) pos = 0;
                    if (pos > w) pos = w;
                    slide(pos);
                }

                function getCursorPos(e) {
                    let a, x = 0;
                    e = (e.changedTouches) ? e.changedTouches[0] : e;
                    a = img.getBoundingClientRect();
                    x = e.pageX - a.left;
                    x = x - window.pageXOffset;
                    return x;
                }

                function slide(x) {
                    img.style.width = x + "px";
                    slider.style.left = img.offsetWidth - (slider.offsetWidth / 2) + "px";
                }
            }
        }

        // expose for buttons in log table
        window.openCompareModal = async (originalUrl, enhancedUrl, button) => {
            const originalText = button.textContent;
            button.textContent = "Loading...";
            button.disabled = true;

            try {
                const [blobOrig, blobEnh] = await Promise.all([
                    fetchImageBlob(originalUrl),
                    fetchImageBlob(enhancedUrl)
                ]);
                initCompareSlider(blobOrig, blobEnh);
            } catch (e) {
                alert("Error loading images for comparison: " + e.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        };

        // --- 11. DOCTOR LOG FUNCTIONALITY ---
        function initDoctorLog() {
            const refreshBtn = document.getElementById("refresh-log-btn");
            const logLoader = document.getElementById("log-loader");
            const tableBody = document.getElementById("log-table-body");

            async function loadLogs() {
                logLoader.classList.remove("hidden");
                tableBody.innerHTML = '';
                try {
                    const response = await fetchWithAuth('http://127.0.0.1:5000/api/patient_log', {
                        method: 'GET'
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    if (!data.log || data.log.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No patient uploads found.</td></tr>';
                        return;
                    }

                    data.log.forEach(entry => {
                        ['originalImageUrl', 'enhancedImageUrl', 'segmentedImageUrl'].forEach(key => {
                            if (entry[key] && !entry[key].startsWith('/api/serve_image/') && !entry[key].startsWith('http')) {
                                const cleanPath = entry[key].startsWith('/') ? entry[key].substring(1) : entry[key];
                                entry[key] = '/api/serve_image/' + cleanPath;
                            }
                        });

                        const row = document.createElement('tr');
                        row.className = "hover:bg-gray-50";

                        let segmentAction = '';
                        if (entry.segmentedImageUrl) {
                            segmentAction = `<button data-url="${entry.segmentedImageUrl}" class="view-image-btn text-purple-600 hover:underline font-semibold ml-2 text-sm">View Segmented</button>`;
                        } else {
                            segmentAction = `<button onclick="segmentImage('${entry.id}', this)" class="text-purple-600 hover:underline font-semibold ml-2 text-sm">Segment Brain</button>`;
                        }

                        row.innerHTML = `
                            <td class="p-3 truncate">${entry.patientName}</td>
                            <td class="p-3 text-sm">${entry.timestamp}</td>
                            <td class="p-3 truncate max-w-[150px]" title="${entry.originalFilename}">${entry.originalFilename}</td>
                            <td class="p-3 flex flex-wrap gap-2 items-center">
                                <button data-url="${entry.originalImageUrl}" class="view-image-btn text-blue-600 hover:underline text-sm">View Original</button>
                                <button data-url="${entry.enhancedImageUrl}" class="view-image-btn text-teal-600 hover:underline font-semibold text-sm">View Enhanced</button>
                                <button onclick="openCompareModal('${entry.originalImageUrl}', '${entry.enhancedImageUrl}', this)" class="text-indigo-600 hover:underline font-bold text-sm border border-indigo-200 px-2 py-1 rounded bg-indigo-50">Compare</button>
                                ${segmentAction}
                                <button onclick="downloadReport('${entry.id}', '${entry.patientName}')" class="text-gray-600 hover:underline font-semibold text-sm">Download Report</button>
                                <button onclick="deleteLog('${entry.id}', this)" class="text-red-600 hover:underline font-semibold text-sm ml-2">Delete Log</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    attachViewButtonListeners();

                } catch (e) {
                    console.error("Error loading log:", e);
                    let errorMsg = e.message;
                    if (e.message.includes("is not valid JSON")) {
                        errorMsg = "Your session may have expired. Please log out and log back in.";
                    }
                    tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error: ${errorMsg}</td></tr>`;
                } finally {
                    logLoader.classList.add("hidden");
                }
            }

            async function openSecureImage(url, button) {
                const originalText = button.textContent;
                button.textContent = "Loading...";
                button.disabled = true;

                try {
                    const response = await fetchWithAuth(url, { method: 'GET' });
                    if (!response.ok) {
                        let errData;
                        try {
                            errData = await response.json();
                        } catch {
                            errData = {};
                        }
                        throw new Error(errData.error || response.statusText);
                    }
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);
                    window.open(imageUrl, '_blank');
                } catch (e) {
                    alert(`Error loading image: ${e.message}`);
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }

            function attachViewButtonListeners() {
                document.querySelectorAll('.view-image-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const url = e.target.getAttribute('data-url');
                        openSecureImage(url, e.target);
                    };
                });
            }

            refreshBtn.onclick = loadLogs;
            loadLogs();
        }

        // --- GLOBAL FUNCTIONS ---
        window.deleteMyData = async () => {
            if (!confirm("Are you sure you want to delete ALL your data? This cannot be undone.")) return;
            try {
                const response = await fetchWithAuth('http://127.0.0.1:5000/api/delete_my_data', { method: 'DELETE' });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                alert(data.message);
                location.reload();
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        window.segmentImage = async (id, btn) => {
            const originalText = btn.textContent;
            btn.textContent = "Segmenting...";
            btn.disabled = true;
            try {
                const response = await fetchWithAuth('http://127.0.0.1:5000/api/segment_image', {
                    method: 'POST',
                    body: JSON.stringify({ log_id: id })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                alert("Segmentation Complete!");
                document.getElementById("refresh-log-btn").click();
            } catch (e) {
                alert("Error: " + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        window.deleteLog = async (id, btn) => {
            if (!confirm("Are you sure you want to delete this log entry?")) return;
            try {
                const response = await fetchWithAuth(`http://127.0.0.1:5000/api/delete_log/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                btn.closest('tr').remove();
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        window.downloadReport = async (id, patientName) => {
            try {
                const response = await fetchWithAuth(`http://127.0.0.1:5000/api/download_report/${id}`, { method: 'GET' });
                if (!response.ok) {
                    let data;
                    try {
                        data = await response.json();
                    } catch {
                        data = {};
                    }
                    throw new Error(data.error || "Failed to generate report");
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Report_${patientName}_${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (e) {
                alert("Error downloading report: " + e.message);
            }
        };
    </script>
</body>

</html>